{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///Users/Fufu/booking/fish-booking-system/app/api/bookings/route.ts"],"sourcesContent":["// app/api/bookings/route.ts\nimport { NextResponse } from \"next/server\";\nimport { PrismaClient } from \"@prisma/client\";\n\nconst prisma = new PrismaClient();\n\n// GET: ดึง bookings ของ user ตาม userId ที่ส่งมาทาง header\nexport async function GET(req: Request) {\n  const userId = req.headers.get(\"userId\");\n  if (!userId) {\n    return NextResponse.json({ message: \"User ID is required\" }, { status: 400 });\n  }\n\n  const userIdNum = Number(userId);\n\n  try {\n    const bookings = await prisma.booking.findMany({\n      where: { userId: userIdNum },\n    });\n\n    return NextResponse.json(bookings);\n  } catch (error) {\n    console.error(\"Error fetching bookings:\", error);\n    return NextResponse.json({ message: \"Error fetching bookings\" }, { status: 500 });\n  }\n}\n\n// ฟังก์ชันคำนวณ weekNumber จากวันที่ (ตัวอย่างใช้ ISO week number)\nconst getISOWeekNumber = (date: Date): number => {\n  const tempDate = new Date(date.getTime());\n  tempDate.setUTCDate(tempDate.getUTCDate() + 4 - (tempDate.getUTCDay() || 7));\n  const yearStart = new Date(Date.UTC(tempDate.getUTCFullYear(), 0, 1));\n  const weekNo = Math.ceil((((tempDate.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);\n  return weekNo;\n};\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n\n    // ตรวจสอบว่ามีฟิลด์ที่จำเป็นทั้งหมดหรือไม่\n    if (\n      !body.code ||\n      !body.team ||\n      !body.customerGroup ||\n      !body.customerName ||\n      !body.price ||\n      !body.dailyQuantities ||\n      !body.userId\n    ) {\n      return NextResponse.json({ error: \"Missing or invalid required fields\" }, { status: 400 });\n    }\n\n    // คำนวณ weekNumber จากวันที่แรกใน dailyQuantities\n    const dates = Object.keys(body.dailyQuantities).map(dateStr => new Date(dateStr));\n    if (dates.length === 0) {\n      return NextResponse.json({ error: \"No dates provided in dailyQuantities\" }, { status: 400 });\n    }\n    const minDate = new Date(Math.min(...dates.map(d => d.getTime())));\n    const weekNumber = getISOWeekNumber(minDate);\n\n    const userIdNum = Number(body.userId);\n\n    const booking = await prisma.booking.create({\n      data: {\n        code: body.code,\n        team: body.team,\n        customerGroup: body.customerGroup,\n        customerName: body.customerName,\n        fishSize: body.fishSize,\n        fishType: body.fishType,\n        price: body.price,\n        dailyQuantities: body.dailyQuantities,\n        weekNumber: weekNumber,\n        userId: userIdNum,\n      },\n    });\n\n    return NextResponse.json(booking, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating booking:\", error);\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\n  }\n}\n\n// DELETE: ลบ booking ตาม id และ code ที่ส่งมาใน query string\n// ตัวอย่างการเรียก: /api/bookings?id=123&code=dogfuse\nexport async function DELETE(req: Request) {\n  try {\n    const url = new URL(req.url);\n    const id = url.searchParams.get(\"id\");\n    const code = url.searchParams.get(\"code\");\n\n    if (!id) {\n      return NextResponse.json({ error: \"Missing ID\" }, { status: 400 });\n    }\n\n    // ตรวจสอบ code ก่อนลบ (ตัวอย่างจาก logic เดิม)\n    const validCodes = [\"edok\", \"dogfuse\", \"wisit\"];\n    if (!code || !validCodes.includes(code)) {\n      return NextResponse.json({ error: \"Invalid code. Deletion not authorized.\" }, { status: 403 });\n    }\n\n    await prisma.booking.delete({ where: { id: parseInt(id, 10) } });\n    return NextResponse.json({ message: \"Booking deleted successfully\" });\n  } catch (error) {\n    console.error(\"Error deleting booking:\", error);\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 191, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}